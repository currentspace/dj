<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SSE Test - Direct Connection</title>
    <style>
      body {
        font-family: monospace;
        padding: 20px;
        background: #1a1a1a;
        color: #e0e0e0;
      }
      button {
        background: #1db954;
        color: white;
        border: none;
        padding: 10px 20px;
        cursor: pointer;
        margin: 5px;
        font-size: 14px;
      }
      button:hover {
        background: #1ed760;
      }
      button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      #log {
        background: #2a2a2a;
        padding: 15px;
        margin-top: 20px;
        max-height: 500px;
        overflow-y: auto;
        white-space: pre-wrap;
        font-size: 12px;
        border: 1px solid #444;
      }
      .error {
        color: #ff6b6b;
      }
      .success {
        color: #51cf66;
      }
      .info {
        color: #74b9ff;
      }
      .warning {
        color: #ffd93d;
      }
      input,
      textarea {
        background: #2a2a2a;
        color: #e0e0e0;
        border: 1px solid #444;
        padding: 8px;
        margin: 5px;
        width: 300px;
        font-family: monospace;
      }
      .section {
        margin: 20px 0;
        padding: 15px;
        border: 1px solid #444;
        border-radius: 5px;
      }
    </style>
  </head>
  <body>
    <h1>SSE Streaming Test</h1>

    <div class="section">
      <h2>1. Setup</h2>
      <div>
        <label>Spotify Token: <input type="text" id="token" placeholder="Your Spotify token" /></label>
        <button onclick="getTokenFromStorage()">Get from localStorage</button>
      </div>
      <div>
        <label>API Base: <input type="text" id="apiBase" value="http://localhost:8787/api" /></label>
      </div>
    </div>

    <div class="section">
      <h2>2. Test Basic SSE</h2>
      <button onclick="testSimpleSSE()">Test GET /api/sse-test/simple</button>
      <button onclick="testPostSSE()">Test POST /api/sse-test/post-stream</button>
    </div>

    <div class="section">
      <h2>3. Test Chat Stream Endpoint</h2>
      <button onclick="testSimplePost()">Test POST to /api/chat-stream/message</button>
    </div>

    <div class="section">
      <h2>4. Full Chat SSE Stream</h2>
      <div>
        <label>Message: <input type="text" id="message" value="What is the tempo of the songs?" /></label>
      </div>
      <div>
        <label>Playlist ID: <input type="text" id="playlistId" placeholder="Optional playlist ID" /></label>
      </div>
      <div>
        <label
          >Mode:
          <select id="mode">
            <option value="analyze">Analyze</option>
            <option value="create">Create</option>
            <option value="edit">Edit</option>
          </select>
        </label>
      </div>
      <button onclick="testSSEStream()">Start SSE Stream</button>
      <button onclick="stopStream()">Stop Stream</button>
    </div>

    <div class="section">
      <h2>5. Debug Commands</h2>
      <button onclick="testRawFetch()">Test Raw Fetch</button>
    </div>

    <div class="section">
      <h2>Event Log</h2>
      <button onclick="clearLog()">Clear Log</button>
      <div id="log"></div>
    </div>

    <script>
      let abortController = null

      function log(message, type = '') {
        const logDiv = document.getElementById('log')
        const timestamp = new Date().toISOString().split('T')[1].slice(0, -1)
        const entry = document.createElement('div')
        entry.className = type
        entry.textContent = `[${timestamp}] ${message}`
        logDiv.appendChild(entry)
        logDiv.scrollTop = logDiv.scrollHeight
      }

      function clearLog() {
        document.getElementById('log').innerHTML = ''
        log('Log cleared', 'info')
      }

      function getTokenFromStorage() {
        const token = localStorage.getItem('spotify_token')
        if (token) {
          document.getElementById('token').value = token
          log('Token retrieved from localStorage', 'success')
        } else {
          log('No token found in localStorage', 'warning')
        }
      }

      async function testSimpleSSE() {
        log('Testing simple SSE GET endpoint...', 'info')
        const apiBase = document.getElementById('apiBase').value

        try {
          const response = await fetch(`${apiBase}/sse-test/simple`)
          log(`Response status: ${response.status}`, response.ok ? 'success' : 'error')
          log(`Content-Type: ${response.headers.get('content-type')}`, 'info')

          if (!response.ok || !response.body) {
            log('Failed to get stream', 'error')
            return
          }

          const reader = response.body.getReader()
          const decoder = new TextDecoder()
          let buffer = ''

          while (true) {
            const {done, value} = await reader.read()
            if (done) break

            buffer += decoder.decode(value, {stream: true})
            const lines = buffer.split('\n')
            buffer = lines.pop() || ''

            for (const line of lines) {
              if (line.startsWith('data: ')) {
                const data = line.slice(6)
                try {
                  const event = JSON.parse(data)
                  log(`SSE Event [${event.type}]: ${JSON.stringify(event.data)}`, 'success')
                } catch (e) {
                  log(`Raw SSE data: ${data}`, 'info')
                }
              }
            }
          }
        } catch (error) {
          log(`Error: ${error.message}`, 'error')
        }
      }

      async function testPostSSE() {
        log('Testing POST SSE endpoint...', 'info')
        const apiBase = document.getElementById('apiBase').value

        try {
          const response = await fetch(`${apiBase}/sse-test/post-stream`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              Accept: 'text/event-stream',
            },
            body: JSON.stringify({test: 'data', timestamp: Date.now()}),
          })

          log(`Response status: ${response.status}`, response.ok ? 'success' : 'error')
          log(`Content-Type: ${response.headers.get('content-type')}`, 'info')

          if (!response.ok || !response.body) {
            log('Failed to get stream', 'error')
            return
          }

          const reader = response.body.getReader()
          const decoder = new TextDecoder()
          let buffer = ''

          while (true) {
            const {done, value} = await reader.read()
            if (done) break

            buffer += decoder.decode(value, {stream: true})
            const lines = buffer.split('\n')
            buffer = lines.pop() || ''

            for (const line of lines) {
              if (line.startsWith('data: ')) {
                const data = line.slice(6)
                try {
                  const event = JSON.parse(data)
                  log(`SSE Event [${event.type}]: ${JSON.stringify(event.data)}`, 'success')
                } catch (e) {
                  log(`Raw SSE data: ${data}`, 'info')
                }
              } else if (line.startsWith(':')) {
                log(`SSE comment: ${line}`, 'info')
              }
            }
          }
        } catch (error) {
          log(`Error: ${error.message}`, 'error')
        }
      }

      async function testSimplePost() {
        log('Testing simple POST...', 'info')

        const token = document.getElementById('token').value
        const apiBase = document.getElementById('apiBase').value

        if (!token) {
          log('No token provided!', 'error')
          return
        }

        try {
          const response = await fetch(`${apiBase}/chat-stream/message`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify({
              message: 'test',
              conversationHistory: [],
              mode: 'analyze',
            }),
          })

          log(`Response status: ${response.status} ${response.statusText}`, response.ok ? 'success' : 'error')
          log(`Response headers:`, 'info')
          for (const [key, value] of response.headers.entries()) {
            log(`  ${key}: ${value}`, 'info')
          }

          if (!response.ok) {
            const text = await response.text()
            log(`Response body: ${text}`, 'error')
          }
        } catch (error) {
          log(`Error: ${error.message}`, 'error')
        }
      }

      async function testSSEStream() {
        log('Starting SSE stream test...', 'info')

        const token = document.getElementById('token').value
        const apiBase = document.getElementById('apiBase').value
        const message = document.getElementById('message').value
        const playlistId = document.getElementById('playlistId').value
        const mode = document.getElementById('mode').value

        if (!token) {
          log('No token provided!', 'error')
          return
        }

        // Build message with optional playlist ID
        let finalMessage = message
        if (playlistId && (mode === 'analyze' || mode === 'edit')) {
          finalMessage = `[Playlist ID: ${playlistId}] ${message}`
          log(`Message with playlist ID: ${finalMessage}`, 'info')
        }

        abortController = new AbortController()

        try {
          log(`POST to ${apiBase}/chat-stream/message`, 'info')
          const response = await fetch(`${apiBase}/chat-stream/message`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              Accept: 'text/event-stream',
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify({
              message: finalMessage,
              conversationHistory: [],
              mode: mode,
            }),
            signal: abortController.signal,
          })

          log(`Response status: ${response.status}`, response.ok ? 'success' : 'error')

          const contentType = response.headers.get('content-type') || ''
          log(`Content-Type: ${contentType}`, contentType.includes('text/event-stream') ? 'success' : 'warning')

          if (!response.ok) {
            const text = await response.text()
            log(`Error response: ${text}`, 'error')
            return
          }

          if (!response.body) {
            log('No response body!', 'error')
            return
          }

          // Read the stream
          const reader = response.body.getReader()
          const decoder = new TextDecoder()
          let buffer = ''
          let eventCount = 0

          while (true) {
            const {done, value} = await reader.read()

            if (done) {
              log('Stream ended', 'info')
              break
            }

            const chunk = decoder.decode(value, {stream: true})
            buffer += chunk

            // Log raw chunks
            if (chunk.trim()) {
              log(`Raw chunk (${chunk.length} bytes): ${chunk.slice(0, 200)}${chunk.length > 200 ? '...' : ''}`, 'info')
            }

            // Parse SSE events
            const lines = buffer.split('\n')
            buffer = lines.pop() || ''

            for (const line of lines) {
              if (line.startsWith('data: ')) {
                eventCount++
                const data = line.slice(6)
                try {
                  const event = JSON.parse(data)
                  log(`Event #${eventCount} [${event.type}]: ${JSON.stringify(event.data).slice(0, 200)}`, 'success')

                  if (event.type === 'done') {
                    log('Received done event', 'success')
                    return
                  }
                  if (event.type === 'error') {
                    log(`Server error: ${event.data}`, 'error')
                    return
                  }
                } catch (e) {
                  log(`Failed to parse event: ${data}`, 'warning')
                }
              } else if (line.startsWith(':')) {
                // Comment or heartbeat
                if (line.includes('heartbeat')) {
                  log('Heartbeat received', 'info')
                }
              }
            }
          }
        } catch (error) {
          if (error.name === 'AbortError') {
            log('Stream aborted', 'warning')
          } else {
            log(`Stream error: ${error.message}`, 'error')
          }
        }
      }

      async function testRawFetch() {
        log('Testing raw fetch...', 'info')

        const token = document.getElementById('token').value
        const apiBase = document.getElementById('apiBase').value

        if (!token) {
          log('No token provided!', 'error')
          return
        }

        const curl = `curl -N -X POST '${apiBase}/chat-stream/message' \\
  -H 'Content-Type: application/json' \\
  -H 'Accept: text/event-stream' \\
  -H 'Authorization: Bearer ${token.slice(0, 20)}...' \\
  -d '{"message": "test", "conversationHistory": [], "mode": "analyze"}'`

        log('Equivalent curl command:', 'info')
        log(curl, 'info')
      }

      function stopStream() {
        if (abortController) {
          abortController.abort()
          log('Stream stopped', 'warning')
        } else {
          log('No active stream', 'info')
        }
      }

      // Initialize
      getTokenFromStorage()
      clearLog()
    </script>
  </body>
</html>
